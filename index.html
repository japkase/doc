<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Allure → Xray Importer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body>
<div class="container py-4">
    <h1 class="mb-3">Allure → Xray Importer</h1>

    <div class="card mb-3">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-12 col-md-6">
                    <label class="form-label">Allure Base URL (data/ ile bitmeli)</label>
                    <input id="allureBaseUrl" type="text" class="form-control" placeholder="https://jenkins/job/.../allure-report/data/" />
                </div>
                <div class="col-12 col-md-6">
                    <label class="form-label">Jira Base URL</label>
                    <input id="jiraBaseUrl" type="text" class="form-control" placeholder="http://jira.local" />
                </div>
                <div class="col-12 col-md-6">
                    <label class="form-label">Xray PAT (Bearer)</label>
                    <input id="xrayPat" type="password" class="form-control" placeholder="XRAY PAT" />
                </div>
                <div class="col-12 col-md-6">
                    <label class="form-label">Allure Auth (Basic/Bearer) Header</label>
                    <input id="allureAuth" type="text" class="form-control" placeholder="Basic base64(user:pass) veya Bearer token" />
                    <div class="form-text">Header değeri aynen gönderilir (X-Allure-Authorization)</div>
                </div>
                <div class="col-12 col-md-6">
                    <label class="form-label">Repository Path (opsiyonel)</label>
                    <input id="repositoryPath" type="text" class="form-control" placeholder="Regresyon/Web" />
                </div>
            </div>
            <div class="mt-3 d-flex gap-2">
                <button id="btnPreview" class="btn btn-secondary">Önizleme</button>
                <button id="btnImport" class="btn btn-primary" disabled>Seçilenleri İçeri Aktar</button>
            </div>
        </div>
    </div>

    <div id="preview" class="card d-none">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>Önizleme</span>
            <div>
                <input type="checkbox" id="chkAll" class="form-check-input me-1" />
                <label for="chkAll" class="form-check-label">Hepsini Seç</label>
            </div>
        </div>
        <div class="card-body">
            <div id="previewSummary" class="mb-2 text-muted"></div>
            <div id="previewList" class="accordion"></div>
        </div>
    </div>
</div>

<script>
let lastPreviewItems = [];

async function callPreview() {
  const allureBaseUrl = el('allureBaseUrl').value.trim();
  const jiraBaseUrl = el('jiraBaseUrl').value.trim();
  const xrayPat = el('xrayPat').value.trim();
  const allureAuth = el('allureAuth').value.trim();

  const res = await fetch('/api/preview', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': xrayPat ? `Bearer ${xrayPat}` : '',
      'X-Allure-Authorization': allureAuth || ''
    },
    body: JSON.stringify({ allureBaseUrl, jiraBaseUrl })
  });

  if (!res.ok) {
    const text = await res.text();
    alert('Önizleme hatası: ' + text);
    return;
  }

  lastPreviewItems = await res.json();
  renderPreview(lastPreviewItems);
}

function renderPreview(items) {
  const preview = el('preview');
  const list = el('previewList');
  const summary = el('previewSummary');
  list.innerHTML = '';
  summary.textContent = `${items.length} test içe aktarılacak.`;
  preview.classList.remove('d-none');

  items.forEach((it, idx) => {
    const stepsHtml = (it.steps || []).map(s => `<li><strong>Action:</strong> ${escapeHtml(s.action)} <strong>Data:</strong> ${escapeHtml(s.data)} <strong>Expected:</strong> ${escapeHtml(s.result)}</li>`).join('');
    const payloadHtml = `<pre class="bg-light p-2 border">${escapeHtml(JSON.stringify(it.issuePayload, null, 2))}</pre>`;
    const chkId = `sel_${idx}`;
    const bodyHtml = `<div class="accordion-item">
      <h2 class="accordion-header" id="h${idx}">
        <div class="d-flex align-items-center w-100">
          <input type="checkbox" class="form-check-input me-2 item-chk" data-uid="${escapeAttr(it.testUid)}" id="${chkId}" />
          <button class="accordion-button collapsed flex-grow-1" type="button" data-bs-toggle="collapse" data-bs-target="#c${idx}">
            ${escapeHtml(it.testName)} (${escapeHtml(it.testUid)})
          </button>
        </div>
      </h2>
      <div id="c${idx}" class="accordion-collapse collapse">
        <div class="accordion-body">
          <h6>Issue Payload</h6>
          ${payloadHtml}
          <h6>Steps</h6>
          <ol>${stepsHtml}</ol>
        </div>
      </div>
    </div>`;
    list.insertAdjacentHTML('beforeend', bodyHtml);
  });

  el('btnImport').disabled = items.length === 0;
  el('chkAll').checked = false;
}

function selectedUids() {
  return Array.from(document.querySelectorAll('.item-chk:checked')).map(chk => chk.getAttribute('data-uid'));
}

async function callImport() {
  const allureBaseUrl = el('allureBaseUrl').value.trim();
  const jiraBaseUrl = el('jiraBaseUrl').value.trim();
  const xrayPat = el('xrayPat').value.trim();
  const allureAuth = el('allureAuth').value.trim();
  const repositoryPath = el('repositoryPath').value.trim();
  const uids = selectedUids();

  if (uids.length === 0) {
    if (!confirm('Hiç test seçmediniz. Hepsini içe aktarmak ister misiniz?')) return;
  }

  const res = await fetch('/api/import', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': xrayPat ? `Bearer ${xrayPat}` : '',
      'X-Allure-Authorization': allureAuth || ''
    },
    body: JSON.stringify({ allureBaseUrl, jiraBaseUrl, repositoryPath, selectedUids: uids })
  });
  const text = await res.text();
  if (!res.ok) {
    alert('Import hatası: ' + text);
  } else {
    alert('Import tamamlandı: ' + text);
  }
}

function escapeHtml(s) {
  if (!s) return '';
  return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
}
function escapeAttr(s) { return (s||'').replace(/"/g, '&quot;'); }
function el(id){ return document.getElementById(id); }

document.getElementById('btnPreview').addEventListener('click', () => { callPreview(); });
document.getElementById('btnImport').addEventListener('click', () => { callImport(); });

document.getElementById('chkAll').addEventListener('change', (e) => {
  const checked = e.target.checked;
  document.querySelectorAll('.item-chk').forEach(chk => { chk.checked = checked; });
});
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
